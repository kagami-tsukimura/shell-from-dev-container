#!/usr/bin/env python3

# ./pyminish
import os
import sys


def builtin_echo(args):
    print("".join(args))


def builtin_exit(args):
    exit(0)


BUILTIN_COMMAND_FUNC_MAPPING = {"echo": builtin_echo, "exit": builtin_exit}


def find_command(command):
    if "/" in command:
        return command if os.path.exists(command) else None

    for path_dir in os.environ["PATH"].split(":"):
        full_path = os.path.join(path_dir, command)
        if os.path.exists(full_path) and not os.path.isdir(full_path):
            return full_path
    return None


def main():
    while True:
        line = input("> ")
        tokens = line.split()

        if len(tokens) == 0:
            continue

        command = tokens[0]
        args = tokens[1:]

        # TODO: run command
        if command in BUILTIN_COMMAND_FUNC_MAPPING:
            BUILTIN_COMMAND_FUNC_MAPPING[command](args)
        else:
            # TODO: External command
            command_path = find_command(command)
            if command_path is None:
                print(f"Command not found: {command}", file=sys.stderr)
                continue

            # シェルの実行
            # NOTE: プロセスを複製して親プロセスと子プロセスに分ける
            pid = os.fork()

            if pid == 0:
                # パスからファイル名を取り出す
                command_basename = os.path.basename(command_path)
                # NOTE: プロセスに関する処理をカーネルに依頼（別プロセス起動）
                os.execve(command_path, [command_basename] + args, os.environ)
            else:
                os.waitpid(pid, 0)
                continue


if __name__ == "__main__":
    main()
